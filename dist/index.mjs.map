{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { ref, inject, type Ref, type App, type Plugin, unref } from \"vue\";\n\n/**\n * Configuration options for creating an i18n instance.\n */\ninterface I18nOptions {\n    /**\n     * The initial locale to use.\n     */\n    locale: string;\n    /**\n     * The fallback locale when translation is missing.\n     */\n    fallbackLocale: string;\n\n    /**\n     * Messages object with translations for different locales.\n     */\n    messages: Record<string, any>;\n\n    /**\n     * Whether to warn on missing translations, defaults to true.\n     */\n    missingWarn?: boolean;\n\n    /**\n     * Whether to inject globally in the same way as Vue I18n, defaults to true.\n     */\n    globalInject?: boolean;\n\n    /**\n     * The global name to use for the i18n instance when globally injected.\n     */\n    globalInjectPrefix?: string;\n\n    /**\n     * The custom rules for pluralization, return the plural form index based on the count.\n     */\n    customPluralRules?: Record<string, PluralRule>;\n}\n\n/**\n * The main i18n instance interface providing translation and locale management.\n */\nexport interface I18nInstance {\n    /**\n     * Translates a key into the current locale's string, optionally interpolating parameters.\n     * @param key - The translation key\n     * @param params - Optional parameters for interpolation, can be a reactive Ref or plain object\n     * @returns The translated string\n     */\n    t: (\n        key: string,\n        params?: Ref<Record<string, any>> | Record<string, any>,\n    ) => string;\n\n    /**\n     * Translates a key into the current locale's string, optionally interpolating parameters and handling pluralization.\n     * @param key - The translation key\n     * @param choice - The count used for pluralization\n     * @param params - Optional parameters for interpolation, can be a reactive Ref or plain object\n     * @returns The translated string\n     */\n    tc: (key: string, count: number, params?: Ref<Record<string, any>> | Record<string, any>) => string;\n    /**\n     * The current locale as a reactive Ref.\n     */\n    locale: Ref<string>;\n    /**\n     * Array of available locales in the messages object.\n     */\n    availableLocales: string[];\n    /**\n     * The messages object containing translations for all locales.\n     */\n    messages: Record<string, any>;\n    /**\n     * The fallback locale to use when translation is missing.\n     */\n    fallbackLocale: string;\n}\n\nexport type PluralRule = (n: number) => number;\n\nconst I18nInjectionKey = Symbol(\"i18n\");\n\nconst NANO_VUE_I18N_PLURAL_SEPARATOR = '\\x01'; // use a special character as separator for plural forms\n\n/**\n * Recursively flattens nested message objects into a flat map with dot-notation keys.\n *\n * @param messages - The nested messages object to flatten\n * @param prefix - Optional prefix for building dot-notation keys (used internally for recursion)\n * @returns A Map where keys are dot-notation paths and values are the translation strings\n */\nfunction flattenMessages(\n    messages: Record<string, any>,\n    prefix = \"\",\n): Map<string, string> {\n    const result = new Map<string, string>();\n\n    const PLURAL_REGEX = /\\s*\\|\\s*/g;\n\n    for (const key in messages) {\n        const fullKey = prefix ? `${prefix}.${key}` : key;\n        const value = messages[key];\n\n        if (typeof value === \"string\") {\n            result.set(fullKey, value.replace(PLURAL_REGEX, NANO_VUE_I18N_PLURAL_SEPARATOR));\n        }\n        else if (Array.isArray(value)) {\n            result.set(fullKey, value.join(NANO_VUE_I18N_PLURAL_SEPARATOR));\n        } else if (typeof value === \"object\" && value !== null) {\n            const nested = flattenMessages(value, fullKey);\n            for (const [nestedKey, nestedValue] of nested) {\n                result.set(nestedKey, nestedValue);\n            }\n        }\n    }\n\n    return result;\n}\n\nfunction constructPluralizationFormsMap(translationMap: Map<string, string>) {\n    const result = new Map<string, string[]>();\n    translationMap.forEach((value, key) => {\n        if (value.includes(NANO_VUE_I18N_PLURAL_SEPARATOR)) result.set(key, value.split(NANO_VUE_I18N_PLURAL_SEPARATOR).map((v) => v.trim()));\n    });\n    return result;\n}\n\nfunction constructPluralizationRulesMap(\n    customRules?: Record<string, PluralRule>,\n) {\n    const result = new Map<string, PluralRule>();\n\n    for (const key in defaultPluralRules) {\n        result.set(key, defaultPluralRules[key]);\n    }\n\n    if (!customRules) return result;\n\n    for (const key in customRules) {\n        result.set(key, customRules[key]);\n    }\n\n    return result;\n}\n\nexport const defaultPluralRules: Record<string, PluralRule> = {\n    zh: () => 0,\n    \"zh-CN\": () => 0,\n    \"zh-TW\": () => 0,\n    en: (n) => (n === 1 ? 0 : 1),\n    ja: () => 0,\n    ko: () => 0,\n    fr: (n) => (n === 0 || n === 1 ? 0 : 1),\n    de: (n) => (n === 1 ? 0 : 1),\n    es: (n) => (n === 1 ? 0 : 1),\n    ru: (n) => {\n        const mod10 = n % 10;\n        const mod100 = n % 100;\n        if (mod10 === 1 && mod100 !== 11) return 0;\n        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) return 1;\n        return 2;\n    },\n    pl: (n) => {\n        if (n === 1) return 0;\n        const mod10 = n % 10;\n        const mod100 = n % 100;\n        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) return 1;\n        return 2;\n    },\n    ar: (n) => {\n        if (n === 0) return 0;\n        if (n === 1) return 1;\n        if (n === 2) return 2;\n        if (n % 100 >= 3 && n % 100 <= 10) return 3;\n        if (n % 100 >= 11 && n % 100 <= 99) return 4;\n        return 5;\n    },\n};\n\n/**\n * Creates a new i18n instance with the provided options.\n *\n * @param options - Configuration options for the i18n instance\n * @returns An I18nInstance that also implements the Vue Plugin interface\n *\n * @example\n * ```ts\n * const i18n = createI18n({\n *   locale: 'en',\n *   fallbackLocale: 'en',\n *   messages: {\n *     en: { greeting: 'Hello {name}!' },\n *     fr: { greeting: 'Bonjour {name}!' }\n *     'zh-CN': { greeting: '你好 {name}！' }\n *   }\n * })\n *\n * app.use(i18n)\n * ```\n */\nexport function createI18n(options: I18nOptions): I18nInstance & Plugin {\n    const locale = ref(options.locale);\n    const messages = options.messages;\n    const fallbackLocale = options.fallbackLocale;\n    const availableLocales = Object.keys(messages);\n    const translationMap: Map<string, string> = flattenMessages(messages);\n    const pluralizationRules = constructPluralizationRulesMap(\n        options.customPluralRules,\n    );\n    const pluralForms = constructPluralizationFormsMap(translationMap);\n\n    function applyPlural(key: string, count: number): string {\n        const forms = pluralForms.get(`${locale.value}.${key}`)\n            ?? pluralForms.get(`${fallbackLocale}.${key}`);\n\n        if (!forms) return getTranslation(key);\n\n        if (forms.length <= 1) return key;\n\n        const rule = pluralizationRules.get(locale.value)\n            ?? pluralizationRules.get(fallbackLocale)\n            ?? ((n) => n === 1 ? 0 : 1);\n\n        const index = rule(Math.abs(count));\n        return forms[Math.min(index, forms.length - 1)];\n    }\n\n    function getTranslation(key: string): string {\n        const translation = translationMap.get(`${locale.value}.${key}`)\n            ?? translationMap.get(`${fallbackLocale}.${key}`);\n\n        if (typeof translation !== \"undefined\") {\n            return translation;\n        }\n        else {\n            if (options.missingWarn !== false) {\n                console.warn(`[i18n (nano)] Missing translation for key: ${key}`);\n            }\n            return key;\n        }\n    }\n\n    const PARAM_REGEX = /\\{(\\w+)\\}/g;\n\n    function t(\n        key: string,\n        params?: Ref<Record<string, any>> | Record<string, any>,\n    ): string {\n        let translation = getTranslation(key);\n        if (!params) return translation;\n\n        const currentParams = unref(params);\n\n        translation = translation.replace(\n            PARAM_REGEX,\n            (match, paramName: string) => {\n                return paramName in currentParams\n                    ? String(currentParams[paramName])\n                    : match;\n            },\n        );\n\n        return translation;\n    }\n\n    function tc(key: string, count: number, params?: Ref<Record<string, any>> | Record<string, any>)  {\n        if (isNaN(count)) {\n            if (options.missingWarn !== false) {\n                console.warn(\n                    `[i18n (nano)] Plural parameter is NaN`\n                );\n            }\n            count = 1; // default to 1 if count is NaN\n        }\n\n        let translation = applyPlural(key, count)\n        if (!params) return translation;\n\n        const currentParams = unref(params);\n        return translation.replace(PARAM_REGEX, (match, paramName: string) => {\n            return paramName in currentParams\n                ? String(currentParams[paramName])\n                : match;\n        });\n    }\n\n    const instance: I18nInstance = {\n        t,\n        tc,\n        locale,\n        availableLocales,\n        messages: messages,\n        fallbackLocale,\n    };\n\n    const plugin: Plugin = {\n        install(app: App) {\n            app.provide(I18nInjectionKey, instance);\n            if (options.globalInject !== false) {\n                if (options.globalInjectPrefix?.length) {\n                    app.config.globalProperties[\n                        `$${options.globalInjectPrefix}T`\n                    ] = t;\n                    app.config.globalProperties[\n                        `$${options.globalInjectPrefix}I18n`\n                    ] = instance;\n                    app.config.globalProperties[\n                        `$${options.globalInjectPrefix}Locale`\n                    ] = locale;\n                    app.config.globalProperties[\n                        `$${options.globalInjectPrefix}Tc`\n                    ] = tc;\n                } else {\n                    app.config.globalProperties[`$t`] = t;\n                    app.config.globalProperties[`$i18n`] = instance;\n                    app.config.globalProperties[`$locale`] = locale;\n                    app.config.globalProperties[\n                        `$tc`\n                    ] = tc;\n                }\n            }\n        },\n    };\n\n    return Object.assign(instance, plugin);\n}\n\n/**\n * Retrieves the i18n instance from the Vue injection context.\n *\n * @returns The I18nInstance provided by the nearest createI18n ancestor\n * @throws Error if called before the i18n plugin is installed via app.use()\n *\n * @example\n * ```ts\n * const { t, locale } = useI18n()\n * console.log(t('greeting', { name: 'World' }))\n * ```\n */\nexport function useI18n(): I18nInstance {\n    const i18n = inject<I18nInstance>(I18nInjectionKey);\n\n    if (!i18n) {\n        throw new Error(\n            \"I18n (nano) instance not found. Did you forget to install the i18n plugin?\",\n        );\n    }\n\n    return i18n;\n}\n"],"mappings":"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","names":["ref","inject","unref","I18nInjectionKey","NANO_VUE_I18N_PLURAL_SEPARATOR","flattenMessages","messages","prefix","result","PLURAL_REGEX","key","fullKey","value","nested","nestedKey","nestedValue","constructPluralizationFormsMap","translationMap","v","constructPluralizationRulesMap","customRules","defaultPluralRules","mod10","mod100","createI18n","options","locale","fallbackLocale","availableLocales","pluralizationRules","pluralForms","applyPlural","count","forms","getTranslation","index","n","translation","PARAM_REGEX","t","params","currentParams","match","paramName","tc","instance","app","useI18n","i18n"]}